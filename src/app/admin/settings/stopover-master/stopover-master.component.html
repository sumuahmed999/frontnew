<div class="stepover-management">
  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-compact mb-3">
    <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
    <button type="button" class="btn-close btn-close-sm" (click)="clearMessages()"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-compact mb-3">
    <i class="bi bi-exclamation-circle me-2"></i>{{ errorMessage }}
    <button type="button" class="btn-close btn-close-sm" (click)="clearMessages()"></button>
  </div>

  <!-- StepOver Form -->
  <div class="stepover-form card">
    <div class="card-header">
      <h5 class="card-title">
        <i class="bi bi-geo-alt me-2"></i>
        {{ editingStepOverId ? 'Edit StepOver' : 'Add New StepOver' }}
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="stepOverForm" (ngSubmit)="onSubmit()">
        <!-- StepOver Master Section -->
        <div class="section-header">
          <h6 class="section-title">
            <i class="bi bi-building me-2"></i>StepOver Details
          </h6>
        </div>

        <!-- Basic Information Row -->
        <div class="form-row">
          <div class="form-col">
            <label class="form-label-compact">StepOver Name *</label>
            <input type="text" formControlName="stepOverName" class="form-control form-control-compact" [disabled]="isLoading">
            <div class="error-space">
              <div *ngIf="stepOverForm.get('stepOverName')?.invalid && stepOverForm.get('stepOverName')?.touched; else spacer1" 
                   class="error-text-compact">StepOver name is required</div>
              <ng-template #spacer1><div class="error-spacer"></div></ng-template>
            </div>
          </div>
          <div class="form-col">
            <div class="form-check-compact">
              <input type="checkbox" formControlName="isActive" class="form-check-input" [disabled]="isLoading">
              <label class="form-check-label-compact">Active Status</label>
            </div>
            <div class="error-space"><div class="error-spacer"></div></div>
          </div>
        </div>

        <!-- Address Row -->
        <div class="form-row">
          <div class="form-col-full">
            <label class="form-label-compact">
              Address *
              <small class="text-muted">(Start typing to search with Google Places)</small>
            </label>
            <div class="input-group">
              <input #addressInput type="text" formControlName="address" 
                     class="form-control form-control-compact" [disabled]="isLoading"
                     placeholder="Search for places, addresses, landmarks..."
                     (focus)="onAddressFocus()"
                     (input)="onAddressInput($event)">
              <button type="button" class="btn btn-outline-secondary btn-compact" 
                      (click)="getCurrentLocation()" [disabled]="isLoading || isGettingLocation"
                      title="Use current location">
                <span *ngIf="isGettingLocation" class="spinner-border spinner-border-sm"></span>
                <i *ngIf="!isGettingLocation" class="bi bi-crosshair"></i>
              </button>
              <button type="button" class="btn btn-outline-primary btn-compact" 
                      (click)="clearAddress()" [disabled]="isLoading"
                      title="Clear address">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <div class="error-space">
              <div *ngIf="stepOverForm.get('address')?.invalid && stepOverForm.get('address')?.touched; else spacer2" 
                   class="error-text-compact">Address is required</div>
              <ng-template #spacer2>
                <small class="text-muted">
                  Try searching for: restaurants, hotels, landmarks, or enter a complete address
                </small>
              </ng-template>
            </div>
          </div>
        </div>

        <!-- Coordinates Row -->
        <div class="form-row">
          <div class="form-col">
            <label class="form-label-compact">Latitude *</label>
            <input type="number" step="0.000001" formControlName="latitude" 
                   class="form-control form-control-compact" [disabled]="isLoading"
                   (input)="onCoordinateChange()">
            <div class="error-space">
              <div *ngIf="stepOverForm.get('latitude')?.invalid && stepOverForm.get('latitude')?.touched; else spacer3" 
                   class="error-text-compact">Valid latitude required (-90 to 90)</div>
              <ng-template #spacer3><div class="error-spacer"></div></ng-template>
            </div>
          </div>
          <div class="form-col">
            <label class="form-label-compact">Longitude *</label>
            <input type="number" step="0.000001" formControlName="longitude" 
                   class="form-control form-control-compact" [disabled]="isLoading"
                   (input)="onCoordinateChange()">
            <div class="error-space">
              <div *ngIf="stepOverForm.get('longitude')?.invalid && stepOverForm.get('longitude')?.touched; else spacer4" 
                   class="error-text-compact">Valid longitude required (-180 to 180)</div>
              <ng-template #spacer4><div class="error-spacer"></div></ng-template>
            </div>
          </div>
          <div class="form-col">
            <label class="form-label-compact">Location Preview</label>
            <div class="coordinate-preview">
              <button type="button" class="btn btn-sm btn-outline-info" 
                      (click)="previewLocation()" 
                      [disabled]="!hasValidCoordinates()"
                      title="Preview location on map">
                <i class="bi bi-map"></i> Preview Map
              </button>
            </div>
          </div>
        </div>

        <!-- Tenant Codes Section -->
        <div class="section-header mt-4">
          <h6 class="section-title">
            <i class="bi bi-people me-2"></i>Tenant Codes
            <small class="text-muted ms-2">({{ tenantCodes.length }} codes added)</small>
          </h6>
        </div>

        <!-- Add Tenant Code Row -->
        <div class="form-row">
          <div class="form-col">
            <label class="form-label-compact">Add Tenant Code</label>
            <div class="input-group">
              <input type="text" 
                     [(ngModel)]="newTenantCode" 
                     [ngModelOptions]="{standalone: true}"
                     class="form-control form-control-compact" 
                     [disabled]="isLoading"
                     placeholder="Enter tenant code"
                     (keyup.enter)="addTenantCode()"
                     maxlength="50"
                     style="text-transform: uppercase;">
              <button type="button" class="btn btn-primary btn-compact" 
                      (click)="addTenantCode()" 
                      [disabled]="isLoading || !newTenantCode?.trim()"
                      title="Add tenant code">
                <i class="bi bi-plus"></i> Add
              </button>
            </div>
            <div class="error-space">
              <small class="text-muted">
                Enter tenant codes one by one and press Add or Enter
              </small>
            </div>
          </div>
          <div class="form-col">
            <label class="form-label-compact">Bulk Add</label>
            <div class="input-group">
              <textarea class="form-control form-control-compact" 
                        [(ngModel)]="bulkTenantCodes"
                        [ngModelOptions]="{standalone: true}"
                        [disabled]="isLoading"
                        placeholder="Enter multiple codes separated by commas or new lines"
                        rows="1"
                        style="resize: vertical; text-transform: uppercase;"></textarea>
              <button type="button" class="btn btn-secondary btn-compact" 
                      (click)="addBulkTenantCodes()" 
                      [disabled]="isLoading || !bulkTenantCodes?.trim()"
                      title="Add bulk tenant codes">
                <i class="bi bi-plus-square"></i> Bulk Add
              </button>
            </div>
            <div class="error-space">
              <small class="text-muted">
                Separate codes with commas or new lines
              </small>
            </div>
          </div>
        </div>

        <!-- Tenant Codes List -->
        <div *ngIf="tenantCodes.length > 0" class="tenant-codes-list mt-3">
          <div class="codes-container">
            <div *ngFor="let code of tenantCodes; let i = index; trackBy: trackByTenantCode" 
                 class="tenant-code-item">
              <div class="code-content">
                <span class="code-text">{{ code.tenantCode }}</span>
                <div class="code-status">
                  <input type="checkbox" 
                         [(ngModel)]="code.isActive"
                         [ngModelOptions]="{standalone: true}"
                         class="form-check-input form-check-input-sm"
                         [disabled]="isLoading">
                  <label class="status-label">Active</label>
                </div>
              </div>
              <button type="button" class="btn btn-outline-danger btn-xs" 
                      (click)="removeTenantCode(i)" 
                      [disabled]="isLoading"
                      title="Remove tenant code">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          
          <!-- Bulk Actions -->
          <div class="bulk-actions mt-2">
            <button type="button" class="btn btn-sm btn-outline-success" 
                    (click)="toggleAllTenantCodes(true)" 
                    [disabled]="isLoading"
                    title="Activate all codes">
              <i class="bi bi-check-all"></i> Activate All
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning ms-2" 
                    (click)="toggleAllTenantCodes(false)" 
                    [disabled]="isLoading"
                    title="Deactivate all codes">
              <i class="bi bi-x-octagon"></i> Deactivate All
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                    (click)="clearAllTenantCodes()" 
                    [disabled]="isLoading"
                    title="Remove all codes">
              <i class="bi bi-trash"></i> Clear All
            </button>
          </div>
        </div>

        <!-- Empty State for Tenant Codes -->
        <div *ngIf="tenantCodes.length === 0" class="empty-tenant-codes mt-3">
          <div class="text-center py-3 text-muted">
            <i class="bi bi-people display-6 mb-2 d-block"></i>
            <p class="mb-0">No tenant codes added yet</p>
            <small>Add tenant codes using the input fields above</small>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-compact" [disabled]="stepOverForm.invalid || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            <span *ngIf="isLoading">{{ editingStepOverId ? 'Updating...' : 'Saving...' }}</span>
            <span *ngIf="!isLoading">
              <i class="bi bi-gear me-1"></i>{{ editingStepOverId ? 'Update StepOver' : 'Save StepOver' }}
            </span>
          </button>
          <button type="button" class="btn btn-secondary btn-compact ms-2" (click)="resetForm()" [disabled]="isLoading">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- StepOvers List (same as before but with tenant count display) -->
  <div class="stepovers-list card mt-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title">
          <i class="bi bi-list me-2"></i>
          StepOvers ({{ totalCount }})
        </h5>
        
        <!-- Search and Filter Controls -->
        <div class="d-flex gap-2">
          <div class="search-container">
            <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()" 
                   class="form-control form-control-sm" placeholder="Search stepovers...">
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="onSearch()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          
          <select [(ngModel)]="filterActive" (change)="onSearch()" class="form-select form-select-sm">
            <option [ngValue]="undefined">All Status</option>
            <option [ngValue]="true">Active Only</option>
            <option [ngValue]="false">Inactive Only</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Loading State -->
      <div *ngIf="isLoadingStepOvers" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Loading stepovers...</div>
      </div>

      <!-- StepOvers Table -->
      <div *ngIf="!isLoadingStepOvers" class="table-responsive">
        <table class="table table-hover table-compact">
          <thead class="table-light">
            <tr>
              <th class="sortable" (click)="onSort('stepover_name')">
                Name <i [class]="getSortIcon('stepover_name')"></i>
              </th>
              <th>Address</th>
              <th>Coordinates</th>
              <th class="sortable" (click)="onSort('is_active')">
                Status <i [class]="getSortIcon('is_active')"></i>
              </th>
              <th>Tenants</th>
              <th class="sortable" (click)="onSort('created_date')">
                Created <i [class]="getSortIcon('created_date')"></i>
              </th>
              <th width="150">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let stepover of stepOvers; trackBy: trackByStepOverId" 
                [class.table-warning]="!stepover.isActive">
              <td>
                <strong>{{ stepover.stepOverName }}</strong>
              </td>
              <td>
                <div class="text-truncate" style="max-width: 250px;" [title]="stepover.address">
                  {{ stepover.address || '-' }}
                </div>
              </td>
              <td>
                <small *ngIf="stepover.latitude && stepover.longitude" class="text-muted">
                  {{ stepover.latitude | number:'1.6-6' }}, {{ stepover.longitude | number:'1.6-6' }}
                </small>
                <span *ngIf="!stepover.latitude || !stepover.longitude">-</span>
              </td>
              <td>
                <span class="badge" [ngClass]="stepover.isActive ? 'bg-success' : 'bg-danger'">
                  <i [class]="stepover.isActive ? 'bi bi-check-circle' : 'bi bi-x-circle'"></i>
                  {{ stepover.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <span class="badge bg-info">{{ stepover.tenantCount || 0 }}</span>
              </td>
              <td>
                <small>{{ stepover.createdDate | date:'short' }}</small>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary btn-xs" 
                          (click)="editStepOver(stepover)" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button type="button" class="btn btn-outline-success btn-xs" 
                          (click)="viewStepOverOnMap(stepover)" title="View on Map"
                          [disabled]="!stepover.latitude || !stepover.longitude">
                    <i class="bi bi-geo-alt"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-xs" 
                          (click)="deleteStepOver(stepover)" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Empty State -->
            <tr *ngIf="stepOvers.length === 0">
              <td colspan="7" class="text-center py-4 text-muted">
                <i class="bi bi-geo-alt display-4 mb-2 d-block"></i>
                No stepovers found
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination (same as before) -->
      <nav *ngIf="totalPages > 1" class="mt-3">
        <ul class="pagination pagination-sm justify-content-center">
          <li class="page-item" [class.disabled]="currentPage <= 1">
            <button class="page-link" (click)="onPageChange(1)" [disabled]="currentPage <= 1">
              <i class="bi bi-chevron-double-left"></i>
            </button>
          </li>
          <li class="page-item" [class.disabled]="currentPage <= 1">
            <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage <= 1">
              <i class="bi bi-chevron-left"></i>
            </button>
          </li>
          
          <li *ngFor="let page of getPaginationNumbers()" 
              class="page-item" [class.active]="page === currentPage">
            <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
          </li>
          
          <li class="page-item" [class.disabled]="currentPage >= totalPages">
            <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage >= totalPages">
              <i class="bi bi-chevron-right"></i>
            </button>
          </li>
          <li class="page-item" [class.disabled]="currentPage >= totalPages">
            <button class="page-link" (click)="onPageChange(totalPages)" [disabled]="currentPage >= totalPages">
              <i class="bi bi-chevron-double-right"></i>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
