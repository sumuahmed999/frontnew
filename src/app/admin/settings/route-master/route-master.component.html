<div class="route-master-container">
  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-compact mb-2">
    <i class="bi bi-check-circle me-1"></i>
    <span class="small">{{ successMessage }}</span>
    <button type="button" class="btn-close btn-close-sm" (click)="clearMessages()"></button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger alert-compact mb-2">
    <i class="bi bi-exclamation-circle me-1"></i>
    <span class="small">{{ errorMessage }}</span>
    <button type="button" class="btn-close btn-close-sm" (click)="clearMessages()"></button>
  </div>

  <!-- Route Form -->
  <div class="route-form card">
    <div class="card-header py-2">
      <h6 class="card-title mb-0 small">
        <i class="bi bi-map me-1"></i>
        {{ editingRouteId ? 'Edit Route' : 'Add New Route' }}
      </h6>
    </div>
    <div class="card-body py-2">
      <form [formGroup]="routeForm" (ngSubmit)="onSubmit()">

        <!-- Basic Route Information -->
        <div class="form-grid mb-3">
          <!-- Route Name -->
          <div class="form-group">
            <label class="form-label text-xs">Route Name *</label>
            <input type="text" formControlName="routeName" class="form-control form-control-sm text-xs"
              [disabled]="isSubmitting" placeholder="Enter route name">
            <div *ngIf="routeForm.get('routeName')?.invalid && routeForm.get('routeName')?.touched"
              class="text-danger text-xs mt-1">
              Route name is required
            </div>
          </div>

          <!-- Start Location -->
          <div class="form-group">
            <label class="form-label text-xs">Start Location *</label>
            <select formControlName="startLocationId" class="form-select form-select-sm text-xs"
              [disabled]="isSubmitting || isLoadingLocations" (change)="onLocationSelectionChange()">
              <option value="">Select Start Location</option>
              <option *ngFor="let location of locations; trackBy: trackByLocationId" [value]="location.locationId">
                {{ location.locationName }}
              </option>
            </select>
            <div *ngIf="isLoadingLocations" class="text-muted text-xs mt-1">
              <i class="spinner-border spinner-border-sm me-1"></i>Loading locations...
            </div>
            <div *ngIf="routeForm.get('startLocationId')?.invalid && routeForm.get('startLocationId')?.touched"
              class="text-danger text-xs mt-1">
              Start location is required
            </div>
          </div>

          <!-- End Location -->
          <div class="form-group">
            <label class="form-label text-xs">End Location *</label>
            <select formControlName="endLocationId" class="form-select form-select-sm text-xs"
              [disabled]="isSubmitting || isLoadingLocations" (change)="onLocationSelectionChange()">
              <option value="">Select End Location</option>
              <option *ngFor="let location of locations; trackBy: trackByLocationId" [value]="location.locationId">
                {{ location.locationName }}
              </option>
            </select>
            <div *ngIf="routeForm.get('endLocationId')?.invalid && routeForm.get('endLocationId')?.touched"
              class="text-danger text-xs mt-1">
              End location is required
            </div>
          </div>

          <!-- Distance -->
          <div class="form-group">
            <label class="form-label text-xs">Distance (km)</label>
            <input type="number" step="0.1" min="0" formControlName="distance"
              class="form-control form-control-sm text-xs" [disabled]="isSubmitting || isCalculatingDistance"
              placeholder="0.0">
            <div *ngIf="routeForm.get('distance')?.invalid && routeForm.get('distance')?.touched"
              class="text-danger text-xs mt-1">
              Distance must be positive
            </div>
          </div>

          <!-- Estimated Time -->
          <div class="form-group">
            <label class="form-label text-xs">Estimated Time</label>
            <input type="text" formControlName="estimatedTime" class="form-control form-control-sm text-xs"
              [disabled]="isSubmitting || isCalculatingDistance" placeholder="e.g., 2h 30m">
          </div>

          <!-- Active Status -->
          <div class="form-group">
            <div class="form-check mt-3">
              <input type="checkbox" formControlName="isActive" class="form-check-input form-check-input-sm"
                [disabled]="isSubmitting">
              <label class="form-check-label text-xs">Active Route</label>
            </div>
          </div>
        </div>

        <!-- Step Overs Section -->
    <!-- Updated Step Overs Section -->
<div class="stepover-section">
  <div class="section-header mb-2">
    <h6 class="section-title text-xs">
      <i class="bi bi-geo-alt me-1"></i>Step Overs with Distance & Time
      <span class="badge badge-sm bg-secondary ms-2">{{ stepOversArray.length }}</span>
    </h6>
    <button type="button" class="btn btn-success btn-xs" (click)="addStepOver()" [disabled]="isSubmitting"
            title="Add Step Over">
      <i class="bi bi-plus"></i> Add Step Over
    </button>
  </div>

  <div formArrayName="stepOvers" class="stepover-list">
    <div *ngFor="let stepOverControl of stepOversArray.controls; let i = index; trackBy: trackByIndex"
         [formGroupName]="i" class="stepover-item mb-2 p-2 border rounded bg-light">
      
      <div class="row g-2 align-items-end">
        <!-- Step Over Selection -->
        <div class="col-md-4">
          <label class="form-label text-xs">Step Over {{ i + 1 }}</label>
          <select formControlName="stepOverId" class="form-select form-select-sm text-xs"
                  [disabled]="isSubmitting || isLoadingStepOvers"
                  (change)="onStepOverLocationChange()">
            <option value="">Select Step Over</option>
            <option *ngFor="let stepOver of stepOvers; trackBy: trackByStepOverId"
                    [value]="stepOver.stepOverId">
              {{ stepOver.stepOverName }}
            </option>
          </select>
        </div>
        
        <!-- Distance from Previous Point -->
        <div class="col-md-3">
          <label class="form-label text-xs">Distance (km)</label>
          <input type="number" formControlName="distance" readonly
                 class="form-control form-control-sm text-xs bg-light"
                 placeholder="Auto-calculated">
          <small class="text-muted text-xs">From previous point</small>
        </div>
        
        <!-- Time from Previous Point -->
        <div class="col-md-3">
          <label class="form-label text-xs">Time (minutes)</label>
          <input type="number" formControlName="time" readonly
                 class="form-control form-control-sm text-xs bg-light"
                 placeholder="Auto-calculated">
          <small class="text-muted text-xs">Est. travel time</small>
        </div>
        
        <!-- Remove Button -->
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-danger btn-xs w-100"
                  (click)="removeStepOver(i)" [disabled]="isSubmitting" title="Remove Step Over">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      
      <!-- Loading indicator for step overs -->
      <div *ngIf="isLoadingStepOvers" class="text-muted text-xs mt-1">
        <i class="spinner-border spinner-border-sm me-1"></i>Loading step overs...
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="stepOversArray.length === 0" class="empty-stepover text-center py-3 text-muted">
      <i class="bi bi-geo-alt display-6 mb-1 d-block"></i>
      <p class="mb-0 small">No step overs added</p>
      <small class="text-xs">Click "Add Step Over" to add stops with distance calculation</small>
    </div>
  </div>
</div>


        <!-- Form Actions -->
        <div class="form-actions mt-3 pt-2 border-top">
          <button type="submit" class="btn btn-primary btn-sm" [disabled]="routeForm.invalid || isSubmitting">
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1"></span>
            <span *ngIf="isSubmitting" class="text-xs">
              {{ editingRouteId ? 'Updating...' : 'Saving...' }}
            </span>
            <span *ngIf="!isSubmitting" class="text-xs">
              <i class="bi bi-save me-1"></i>{{ editingRouteId ? 'Update' : 'Save' }} Route
            </span>
          </button>
          <button type="button" class="btn btn-secondary btn-sm ms-2" (click)="resetForm()" [disabled]="isSubmitting">
            <i class="bi bi-x-circle me-1"></i><span class="text-xs">Reset</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Routes List -->
  <div class="routes-list card mt-3">
    <div class="card-header py-2">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <h6 class="card-title mb-0 small">
          <i class="bi bi-list me-1"></i>
          Routes <span class="badge badge-sm bg-primary">{{ routeTotalCount }}</span>
        </h6>

        <!-- Search and Filter Controls -->
        <div class="d-flex gap-2 flex-wrap">
          <div class="input-group input-group-sm" style="width: 200px;">
            <input type="text" [(ngModel)]="routeSearchTerm" (keyup.enter)="onRouteSearch()"
              class="form-control text-xs" placeholder="Search routes...">
            <button type="button" class="btn btn-outline-primary btn-sm px-2" (click)="onRouteSearch()">
              <i class="bi bi-search"></i>
            </button>
          </div>

          <select [(ngModel)]="routeFilterActive" (change)="onRouteSearch()" class="form-select form-select-sm text-xs"
            style="width: auto;">
            <option [ngValue]="undefined">All Status</option>
            <option [ngValue]="true">Active</option>
            <option [ngValue]="false">Inactive</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      <!-- Loading State -->
      <div *ngIf="isLoadingRoutes" class="text-center py-3">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <div class="mt-1 small">Loading routes...</div>
      </div>

      <!-- Routes Table -->
      <div *ngIf="!isLoadingRoutes" class="table-responsive">
        <table class="table table-hover table-sm table-compact mb-0">
          <thead class="table-light">
            <tr>
              <th class="py-2 text-xs">Route Name</th>
              <th class="py-2 text-xs">Start → End</th>
              <th class="py-2 text-xs">Distance</th>
              <th class="py-2 text-xs">Est. Time</th>
              <th class="py-2 text-xs">Step Overs</th>
              <th class="py-2 text-xs">Status</th>
              <th class="py-2 text-xs">Created</th>
              <th class="py-2 text-xs" width="120">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let route of routes; trackBy: trackByRouteId" [class.table-warning]="!route.isActive">
              <td class="py-2">
                <strong class="text-xs">{{ route.routeName }}</strong>
              </td>
              <td class="py-2">
                <div class="text-xs">
                  {{ route.startLocation.name }} → {{ route.endLocation.name }}
                </div>
              </td>
              <td class="py-2">
                <span class="text-xs">{{ route.distanceKm }} km</span>
              </td>
              <td class="py-2">
                <span class="text-xs">{{ route.estimatedTime || 'N/A' }}</span>
              </td>
              <td class="py-2">
                <span class="badge badge-sm bg-info">{{ route.stepOvers?.length || 0 }}</span>
                <!-- <span class="badge badge-sm bg-info">{{ getStepOverCount(route) }}</span> -->
                <div *ngIf="hasStepOvers(route)" class="text-xs text-muted mt-1">
                  {{ getStepOverNames(route) }}
                </div>
              </td>
              <td class="py-2">
                <span class="badge badge-sm" [ngClass]="route.isActive ? 'bg-success' : 'bg-danger'">
                  <i [class]="route.isActive ? 'bi bi-check' : 'bi bi-x'"></i>
                  {{ route.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="py-2">
                <small class="text-xs">{{ route.createdDate | date:'short' }}</small>
              </td>
              <td class="py-2">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary btn-xs px-1" (click)="editRoute(route)"
                    title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-xs px-1" (click)="deleteRoute(route)"
                    title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>

            <!-- Empty State -->
            <tr *ngIf="routes.length === 0">
              <td colspan="8" class="text-center py-4 text-muted">
                <i class="bi bi-map display-4 mb-2 d-block"></i>
                <div class="small">No routes found</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <nav *ngIf="routeTotalPages > 1" class="mt-2 px-3 pb-2">
        <ul class="pagination pagination-sm justify-content-center mb-0">
          <li class="page-item" [class.disabled]="routeCurrentPage <= 1">
            <button class="page-link px-2 py-1 text-xs" (click)="onRoutePageChange(1)"
              [disabled]="routeCurrentPage <= 1">
              <i class="bi bi-chevron-double-left"></i>
            </button>
          </li>
          <li class="page-item" [class.disabled]="routeCurrentPage <= 1">
            <button class="page-link px-2 py-1 text-xs" (click)="onRoutePageChange(routeCurrentPage - 1)"
              [disabled]="routeCurrentPage <= 1">
              <i class="bi bi-chevron-left"></i>
            </button>
          </li>

          <li *ngFor="let page of getRoutePaginationNumbers()" class="page-item"
            [class.active]="page === routeCurrentPage">
            <button class="page-link px-2 py-1 text-xs" (click)="onRoutePageChange(page)">{{ page }}</button>
          </li>

          <li class="page-item" [class.disabled]="routeCurrentPage >= routeTotalPages">
            <button class="page-link px-2 py-1 text-xs" (click)="onRoutePageChange(routeCurrentPage + 1)"
              [disabled]="routeCurrentPage >= routeTotalPages">
              <i class="bi bi-chevron-right"></i>
            </button>
          </li>
          <li class="page-item" [class.disabled]="routeCurrentPage >= routeTotalPages">
            <button class="page-link px-2 py-1 text-xs" (click)="onRoutePageChange(routeTotalPages)"
              [disabled]="routeCurrentPage >= routeTotalPages">
              <i class="bi bi-chevron-double-right"></i>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>